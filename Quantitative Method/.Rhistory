# White 總共會有九個變量()
# 一樣是關注Rsquare
incomesq <- income^2
agesq <- age^2
kidssq <- kids^2
income_age <- income*age
age_kids <- age*kids
kids_income <-kids*income
W <- lm(esq~income+age+kids+incomesq+agesq+kidssq+income_age+age_kids+kids_income)
summary(W)
#最後一樣是由F統計導到卡方的nR^2（和BP很像）
LMW <- n*0.2
LMW
pvchisq <- 1-pchisq(LMW,df=9)
pvchisq
# 7.598525e-06 是接近於0的，那就代表變量存在變異數異質性。然後BP White test都是拒絕的。
summary(W)
HCVCOV <- vcovHC(lse4)
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(les4, vcov=HCVCOV)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
lse4
HCresults4
summary(lse4)
HCresults4
summary(lse4)
percapitaEE_star <- percapitaEE/percapitaGDP^0.5
intercept_star <- 1/percapitaGDP^0.5
percapitaGDP_star <- percapitaGDP^0.5
wlse4 <- lm(percapitaEE_star~intercept_star+percapitaGDP_star-1)
summary(wlse4)
HCresults4
summary(lse4)
summary(wlse4) #standard error of betahat2 =
HCresults4 #
summary(lse4) #
summary(wlse4) #standard error of betahat2 = 1.62983
HCresults4 #standard error of betahat2 = 2.29921
summary(lse4) #standard error of betahat2 = 1.8662
residuals(wlse4)
wlse_residual <- as.matrix(residuals(wlse4))
wlse_residual
wlse_esq <- wlse_residual^2
wlse_esq
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
wlse4_esq
wlse4
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
adjusted_Heterotest
summary(adjusted_Heterotest)
summary(adjusted_Heterotest)
n4 <- nrow(X4)
n4
adjusted_BP <- 0.08815*34
adjusted_BP <- 0.08815*n4
adjusted_BP
adjusted_BP <- 0.08815*n4
adjusted_BP #2.9971
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=1)
adjusted_BP_pvchisq
Wtest4 <- bptest(lse4~percapitaGDP+percapitaGDPsquare)
percapitaGDPsquare <- percapitaGDP^2
Wtest4 <- bptest(lse4,~percapitaGDP+percapitaGDPsquare)
Wtest4 <- bptest(lse4~percapitaGDP+percapitaGDPsquare)
percapitaEE_star_sq <- percapitaEE_star^2
percapitaEE_star_sq
adjusted_W <- lm(wlse_esq~percapitaEE_star+percapitaEE_star_sq)
summary(adjusted_W)
adjusted_LMW <- 0.06335*n4
adjusted_LMW
pvchisq <- 1-pchisq(adjusted_LMW,df=2)
pvchisq
knitr::opts_chunk$set(echo = TRUE)
dataset4 <- read.csv("./data_for_homework_4.csv",header=TRUE)
dataset4
percapitaEE <- dataset4$EE/dataset4$P
percapitaGDP <- dataset4$EE/dataset4$GDP
lse4 <- lm(percapitaEE~percapitaGDP)
summary(lse4)
y4 <- as.matrix(percapitaEE)
percapitaEE
y4
X4 <- cbind(1, percapitaGDP)
percapitaGDP
X4
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
library(lmtest)
BPtest4 <- bptest(lse4)
BPtest4
#p-value = 0.01934 then we will reject H0 and there is Hetero.
### 純手動做BPtest
BP4 <- lm(esq4~percapitaGDP)
summary(BP4)
LMBP4 <- 0.1609*n4 #5.4706
pvchisq4 <- 1-pchisq(LMBP4,df=1)
pvchisq4
# pvchisq4=0.01933899 <5%  then we will reject H0 and there is Hetero.
percapitaGDPsquare <- percapitaGDP^2
Wtest4 <- bptest(lse4,~percapitaGDP+percapitaGDPsquare)
Wtest4
# Wtest4=0.05447 > 5%  then we won't reject H0
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
summary(lse4)
# beta2 hat are the same and standard error is different.
percapitaEE_star <- percapitaEE/percapitaGDP^0.5
intercept_star <- 1/percapitaGDP^0.5
percapitaGDP_star <- percapitaGDP^0.5
wlse4 <- lm(percapitaEE_star~intercept_star+percapitaGDP_star-1)
summary(wlse4) #standard error of betahat2 = 1.62983
HCresults4 #standard error of betahat2 = 2.29921
summary(lse4) #standard error of betahat2 = 1.8662
# the wlse's standard error of betahat2 is the smallest.
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上市不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
wlse4_esq
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
# Multiple R-squared:  0.08815
adjusted_BP <- 0.08815*n4
adjusted_BP #2.9971
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=1)
adjusted_BP_pvchisq #0.0834137 > 5% not rejected H0: Homo
percapitaEE_star_sq <- percapitaEE_star^2
percapitaEE_star_sq
adjusted_W <- lm(wlse_esq~percapitaEE_star+percapitaEE_star_sq)
summary(adjusted_W) #Multiple R-squared:  0.06335
adjusted_LMW <- 0.06335*n4
adjusted_LMW
pvchisq <- 1-pchisq(adjusted_LMW,df=2)
pvchisq # 0.3406329 > 5% not rejected H0: Homo
dataset4 <- read.csv("./data_for_homework_4.csv",header=TRUE)
percapitaEE <- dataset4$EE/dataset4$P
percapitaGDP <- dataset4$EE/dataset4$GDP
lse4 <- lm(percapitaEE~percapitaGDP)
summary(lse4)
percapitaEE <- dataset4$EE/dataset4$P
percapitaGDP <- dataset4$GDP/dataset4$P
lse4 <- lm(percapitaEE~percapitaGDP)
summary(lse4)
dataset4 <- read.csv("./data_for_homework_4.csv",header=TRUE)
percapitaEE <- dataset4$EE/dataset4$P
percapitaGDP <- dataset4$GDP/dataset4$P
lse4 <- lm(percapitaEE~percapitaGDP)
summary(lse4)
y4 <- as.matrix(percapitaEE)
percapitaEE
y4
X4 <- cbind(1, percapitaGDP)
percapitaGDP
X4
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
library(lmtest)
BPtest4 <- bptest(lse4)
BPtest4
#p-value = 0.01934 then we will reject H0 and there is Hetero.
### 純手動做BPtest
BP4 <- lm(esq4~percapitaGDP)
summary(BP4)
LMBP4 <- 0.1609*n4 #5.4706
pvchisq4 <- 1-pchisq(LMBP4,df=1)
pvchisq4
# pvchisq4=0.01933899 <5%  then we will reject H0 and there is Hetero.
percapitaGDPsquare <- percapitaGDP^2
Wtest4 <- bptest(lse4,~percapitaGDP+percapitaGDPsquare)
Wtest4
# Wtest4=0.05447 > 5%  then we won't reject H0
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
summary(lse4)
# beta2 hat are the same and standard error is different.
percapitaEE_star <- percapitaEE/percapitaGDP^0.5
intercept_star <- 1/percapitaGDP^0.5
percapitaGDP_star <- percapitaGDP^0.5
wlse4 <- lm(percapitaEE_star~intercept_star+percapitaGDP_star-1)
summary(wlse4) #standard error of betahat2 = 1.62983
HCresults4 #standard error of betahat2 = 2.29921
summary(lse4) #standard error of betahat2 = 1.8662
# the wlse's standard error of betahat2 is the smallest.
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上市不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
wlse4_esq
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
# Multiple R-squared:  0.08815
adjusted_BP <- 0.08815*n4
adjusted_BP #2.9971
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=1)
adjusted_BP_pvchisq #0.0834137 > 5% not rejected H0: Homo
percapitaEE_star_sq <- percapitaEE_star^2
percapitaEE_star_sq
adjusted_W <- lm(wlse_esq~percapitaEE_star+percapitaEE_star_sq)
summary(adjusted_W) #Multiple R-squared:  0.06335
adjusted_LMW <- 0.06335*n4
adjusted_LMW
pvchisq <- 1-pchisq(adjusted_LMW,df=2)
pvchisq # 0.3406329 > 5% not rejected H0: Homo
y4 <- as.matrix(percapitaEE)
X4 <- cbind(1, percapitaGDP)
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
b4
lse4
b4
y4 <- as.matrix(percapitaEE)
X4 <- cbind(1, percapitaGDP)
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
library(lmtest)
BPtest4 <- bptest(lse4)
BPtest4
#p-value = 0.01934 then we will reject H0 and there is Hetero.
### 純手動做BPtest
#BP4 <- lm(esq4~percapitaGDP)
#summary(BP4)
#LMBP4 <- 0.1609*n4 #5.4706
#pvchisq4 <- 1-pchisq(LMBP4,df=1)
#pvchisq4
# pvchisq4=0.01933899 <5%  then we will reject H0 and there is Hetero.
percapitaGDPsquare <- percapitaGDP^2
Wtest4 <- bptest(lse4,~percapitaGDP+percapitaGDPsquare)
Wtest4
# Wtest4=0.05447 > 5%  then we won't reject H0
HCresults4
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
summary(lse4)
# beta2hat are the same and standard error is different.
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
summary(lse4)
# beta2hat are the same and standard error is different.
percapitaEE_star <- percapitaEE/percapitaGDP^0.5
intercept_star <- 1/percapitaGDP^0.5
percapitaGDP_star <- percapitaGDP^0.5
wlse4 <- lm(percapitaEE_star~intercept_star+percapitaGDP_star-1)
summary(wlse4) #standard error of betahat2 = 1.62983
HCresults4 #standard error of betahat2 = 2.29921
summary(lse4) #standard error of betahat2 = 1.8662
# the wlse's standard error of betahat2 is the smallest.
summary(wlse4) #standard error of betahat2 = 1.62983
HCresults4 #standard error of betahat2 = 2.29921
summary(wlse4) #standard error of betahat2 = 1.62983
HCresults4 #standard error of betahat2 = 2.29921
summary(lse4) #standard error of betahat2 = 1.8662
percapitaEE_star <- percapitaEE/percapitaGDP^0.5
intercept_star <- 1/percapitaGDP^0.5
percapitaGDP_star <- percapitaGDP^0.5
wlse4 <- lm(percapitaEE_star~intercept_star+percapitaGDP_star-1)
summary(wlse4) #standard error of betahat2 = 1.62983
HCresults4 #standard error of betahat2 = 2.29921
summary(lse4) #standard error of betahat2 = 1.8662
# the wlse's standard error of betahat2 is the smallest.
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
summary(lse4)
# beta2hat are the same and standard error is different.
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
wlse4_esq
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
wlse4_esq <- wlse_residual^2
wlse4_esq
summary(adjusted_Heterotest)
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
wlse4_esq
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
# Multiple R-squared:  0.0727
adjusted_BP <- 0.0727*n4
adjusted_BP #2.9971
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=1)
adjusted_BP_pvchisq #0.0834137 > 5% not rejected H0: Homo
# Multiple R-squared:  0.0727
adjusted_BP <- 0.0727*n4
adjusted_BP #2.4718
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=2)
adjusted_BP_pvchisq #0.0834137 > 5% not rejected H0: Homo
dataset4 <- read.csv("./data_for_homework_4.csv",header=TRUE)
percapitaEE <- dataset4$EE/dataset4$P
percapitaGDP <- dataset4$GDP/dataset4$P
lse4 <- lm(percapitaEE~percapitaGDP)
summary(lse4)
y4 <- as.matrix(percapitaEE)
X4 <- cbind(1, percapitaGDP)
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
library(lmtest)
BPtest4 <- bptest(lse4)
BPtest4
#p-value = 0.006701 < 5% then we will reject H0 and there is Hetero.
### 純手動做BPtest
#BP4 <- lm(esq4~percapitaGDP)
#summary(BP4)
#LMBP4 <- 0.1609*n4 #5.4706
#pvchisq4 <- 1-pchisq(LMBP4,df=1)
#pvchisq4
# pvchisq4=0.01933899 <5%  then we will reject H0 and there is Hetero.
percapitaGDPsquare <- percapitaGDP^2
Wtest4 <- bptest(lse4,~percapitaGDP+percapitaGDPsquare)
Wtest4
# Wtest4=0.006869 < 5% then we will reject H0 and there is Hetero.
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
summary(lse4)
# beta2hat are the same and standard error is different.
percapitaEE_star <- percapitaEE/percapitaGDP^0.5
intercept_star <- 1/percapitaGDP^0.5
percapitaGDP_star <- percapitaGDP^0.5
wlse4 <- lm(percapitaEE_star~intercept_star+percapitaGDP_star-1)
summary(wlse4) #standard error of betahat2 = 0.004412
HCresults4 #standard error of betahat2 = 0.0066033
summary(lse4) #standard error of betahat2 = 0.005179
# the wlse's standard error of betahat2 is the smallest.
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
# Multiple R-squared:  0.0727
adjusted_BP <- 0.0727*n4
adjusted_BP #2.4718
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=2) #df=2 because intercept_star & percapitaGDP_star
adjusted_BP_pvchisq #0.2905731 > 5% not rejected H0: Homo
?vcovHC #Heteroskedasticity-consistent estimation of the covariance matrix of the coefficient estimates in regression models.
#vcovHC 來自package(sandwich)
HCVCOV <- vcovHC(lse)
HCVCOV # function結果
AsyVCOV # White1980手動結果
Star <- array(0,dim=c(k,k)) #array 陣列 #dim參數 是維度的設定，這邊要k by k 矩陣matrix差別大嗎？（差異不大，僅只於資料型態當初設計規則）
class(Star)
# 這邊要參考11/22的筆記一開始
#這邊(n/nmk)是為了？
#因為 White 1980是在大樣本的情況下，那目前n=200是有限樣本。修正的方式有很多種， 那Johnston有提供幾種方式，那這邊僅是一種修正方式，往正確的AsyVar靠近一些。
#x 是筆記一開始最上面寫的X ；t(x) 是筆記中的第二個X'
for(i in 1:n){
x <- as.matrix(X[i,]) #截取第i row 然後所有的column(而且因為有for迴圈，所以會是x1 x2 x3 x4)
iter <- (n/nmk)*esq[i]*x%*%t(x)
Star <- Star+iter #iter 是k by k 矩陣
}
Star #=segma Ui hat 平方乘以xi 乘以xi transport，也就是最後公式中間的那段。
AsyVCOV <- solve(crossprod(X,X))%*%Star%*%solve(crossprod(X,X))
AsyVCOV
Asyvar <- as.matrix(diag(AsyVCOV))
Asyvar
Asyse <- Asyvar^0.5
Asyse #調整過後的standard error
trat <- b/Asyse #b-0/Asyse = tratio
pvt <- 2*pt(-abs(trat),df=nmk) #跟上禮拜的相同
pvt
results <- cbind(b,Asyse,trat,pvt)
results
colnames(results) <- c("Estimate","Std. Error","t value","Pr(>|t|)")
rownames(results) <- c("intercept","income","age","kids")
round(results,digits=4)
#比較和lse的差別，estimate沒有變，那standard error有變
results
summary(lse)
?vcovHC #Heteroskedasticity-consistent estimation of the covariance matrix of the coefficient estimates in regression models.
#vcovHC 來自package(sandwich)
HCVCOV <- vcovHC(lse)
HCVCOV # function結果
AsyVCOV # White1980手動結果
# HCVCOV AsyVCOV
HCresults <- coeftest(lse,vcov=HCVCOV) #coeftest也是來自library(lmtest)
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
# 兩者之間一樣是Estimate相同。 Std. Error不同。
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
lm(wlse4_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
lm(wlse4_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
lm(wlse4_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
adjusted_BP <- 0.05016*n4
adjusted_BP #2.4718
# Multiple R-squared:  0.05016
adjusted_BP <- 0.05016*n4
adjusted_BP #1.70544
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=2) #df=2 because intercept_star & percapitaGDP_star
adjusted_BP_pvchisq #0.2905731 > 5% not rejected H0: Homo
# Multiple R-squared:  0.05016
adjusted_BP <- 0.05016*n4
adjusted_BP #1.70544
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=2) #df=2 because intercept_star & percapitaGDP_star
adjusted_BP_pvchisq #0.4262539 > 5% not rejected H0: Homo
y4 <- as.matrix(percapitaEE)
X4 <- cbind(1, percapitaGDP)
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
y4 <- as.matrix(percapitaEE)
X4 <- cbind(1, percapitaGDP)
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
library(lmtest)
W <- lm(esq~income+age+kids+incomesq+agesq+kidssq+income_age+age_kids+kids_income)
summary(W)
