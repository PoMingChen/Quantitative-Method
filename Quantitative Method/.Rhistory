#p-value = 0.006701 < 5% then we will reject H0 and there is Hetero.
### 純手動做BPtest
#BP4 <- lm(esq4~percapitaGDP)
#summary(BP4)
#LMBP4 <- 0.1609*n4 #5.4706
#pvchisq4 <- 1-pchisq(LMBP4,df=1)
#pvchisq4
# pvchisq4=0.01933899 <5%  then we will reject H0 and there is Hetero.
percapitaGDPsquare <- percapitaGDP^2
Wtest4 <- bptest(lse4,~percapitaGDP+percapitaGDPsquare)
Wtest4
# Wtest4=0.006869 < 5% then we will reject H0 and there is Hetero.
library(lmtest)
library(sandwich)
HCVCOV <- vcovHC(lse4)
HCresults4 <- coeftest(lse4, vcov=HCVCOV)
HCresults4
summary(lse4)
# beta2hat are the same and standard error is different.
percapitaEE_star <- percapitaEE/percapitaGDP^0.5
intercept_star <- 1/percapitaGDP^0.5
percapitaGDP_star <- percapitaGDP^0.5
wlse4 <- lm(percapitaEE_star~intercept_star+percapitaGDP_star-1)
summary(wlse4) #standard error of betahat2 = 0.004412
HCresults4 #standard error of betahat2 = 0.0066033
summary(lse4) #standard error of betahat2 = 0.005179
# the wlse's standard error of betahat2 is the smallest.
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
lm(wlse_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
# Multiple R-squared:  0.0727
adjusted_BP <- 0.0727*n4
adjusted_BP #2.4718
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=2) #df=2 because intercept_star & percapitaGDP_star
adjusted_BP_pvchisq #0.2905731 > 5% not rejected H0: Homo
?vcovHC #Heteroskedasticity-consistent estimation of the covariance matrix of the coefficient estimates in regression models.
#vcovHC 來自package(sandwich)
HCVCOV <- vcovHC(lse)
HCVCOV # function結果
AsyVCOV # White1980手動結果
Star <- array(0,dim=c(k,k)) #array 陣列 #dim參數 是維度的設定，這邊要k by k 矩陣matrix差別大嗎？（差異不大，僅只於資料型態當初設計規則）
class(Star)
# 這邊要參考11/22的筆記一開始
#這邊(n/nmk)是為了？
#因為 White 1980是在大樣本的情況下，那目前n=200是有限樣本。修正的方式有很多種， 那Johnston有提供幾種方式，那這邊僅是一種修正方式，往正確的AsyVar靠近一些。
#x 是筆記一開始最上面寫的X ；t(x) 是筆記中的第二個X'
for(i in 1:n){
x <- as.matrix(X[i,]) #截取第i row 然後所有的column(而且因為有for迴圈，所以會是x1 x2 x3 x4)
iter <- (n/nmk)*esq[i]*x%*%t(x)
Star <- Star+iter #iter 是k by k 矩陣
}
Star #=segma Ui hat 平方乘以xi 乘以xi transport，也就是最後公式中間的那段。
AsyVCOV <- solve(crossprod(X,X))%*%Star%*%solve(crossprod(X,X))
AsyVCOV
Asyvar <- as.matrix(diag(AsyVCOV))
Asyvar
Asyse <- Asyvar^0.5
Asyse #調整過後的standard error
trat <- b/Asyse #b-0/Asyse = tratio
pvt <- 2*pt(-abs(trat),df=nmk) #跟上禮拜的相同
pvt
results <- cbind(b,Asyse,trat,pvt)
results
colnames(results) <- c("Estimate","Std. Error","t value","Pr(>|t|)")
rownames(results) <- c("intercept","income","age","kids")
round(results,digits=4)
#比較和lse的差別，estimate沒有變，那standard error有變
results
summary(lse)
?vcovHC #Heteroskedasticity-consistent estimation of the covariance matrix of the coefficient estimates in regression models.
#vcovHC 來自package(sandwich)
HCVCOV <- vcovHC(lse)
HCVCOV # function結果
AsyVCOV # White1980手動結果
# HCVCOV AsyVCOV
HCresults <- coeftest(lse,vcov=HCVCOV) #coeftest也是來自library(lmtest)
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
# 兩者之間一樣是Estimate相同。 Std. Error不同。
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
results #手動結果
#vcov 參數，你想要使用哪一個vcov 並進行假設檢定
HCresults #function結果
lm(wlse4_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
lm(wlse4_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
# 調整過後的WLS，想要看看他是否也存在Hetero的問題。理論上不會再有變異數異質性的問題，不然就白做工了。
wlse_residual <- as.matrix(residuals(wlse4))
wlse4_esq <- wlse_residual^2
lm(wlse4_esq~intercept_star+percapitaGDP_star) -> adjusted_Heterotest
summary(adjusted_Heterotest)
adjusted_BP <- 0.05016*n4
adjusted_BP #2.4718
# Multiple R-squared:  0.05016
adjusted_BP <- 0.05016*n4
adjusted_BP #1.70544
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=2) #df=2 because intercept_star & percapitaGDP_star
adjusted_BP_pvchisq #0.2905731 > 5% not rejected H0: Homo
# Multiple R-squared:  0.05016
adjusted_BP <- 0.05016*n4
adjusted_BP #1.70544
adjusted_BP_pvchisq <- 1-pchisq(adjusted_BP, df=2) #df=2 because intercept_star & percapitaGDP_star
adjusted_BP_pvchisq #0.4262539 > 5% not rejected H0: Homo
y4 <- as.matrix(percapitaEE)
X4 <- cbind(1, percapitaGDP)
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
y4 <- as.matrix(percapitaEE)
X4 <- cbind(1, percapitaGDP)
b4 <- crossprod(solve(crossprod(X4,X4)),crossprod(X4,y4))
b4
lse4
e4 <- y4-X4%*%b4
esq4 <- e4^2
esq4
X4
n4 <- nrow(X4)
n4
k4 <- ncol(X4)
df <- n4-k4
df
library(lmtest)
W <- lm(esq~income+age+kids+incomesq+agesq+kidssq+income_age+age_kids+kids_income)
summary(W)
library("AER")
install.packages("AER")
library("AER")
library("ggplot2")
library("dplyr")
library("knitr")
knitr::opts_chunk$set(echo = TRUE)
data("Journals")
str(Journals)
args(Journals)
str(Journals)
data("Journals")
str(Journals)
data("Journals")
str("Journals")
data("Journals")
str(Journals)
View(Journals)
Journals
Journals %>% mutate(citeprice=price/citations) -> journals
summary(journals)
journals
summary(journals)
Journals %>% mutate(citeprice=price/citations) -> journals
#journals
summary(journals)
#price，圖書館訂閱某期刊的價格
#citations，某期刊被引用的次數
library(psych)
journals %>%
select(citeprice,subs) %>%
pairs.panels()
library(psych)
journals %>%
select(citeprice,subs) %>%
pairs.panels()
# 引用單價citeprice，如何影響訂閱subs，進到一個類似x影響y，需求的概念
# -0.42有點類似需求
library(psych)
# journals %>%
#   select(citeprice,subs) %>%
#   pairs.panels()
# 更理想的寫法
journals %>%
dplyr::select(citeprice,subs) %>%
pairs.panels()
journals %>%
select(citeprice,subs) %>%
mutate_all(log) %>%
pairs.panels()
journals %>%
dplyr::select(citeprice,subs) %>%
dplyr::mutate_all(log) %>%
pairs.panels()
View(Journals)
View(Journals)
Journals
# 判斷變數是否為數值類別
is_numeric<-function(x) all(is.numeric(x))
# 計算數數與citeprice的相關係數
cor_citeprice<-function(x) cor(x,journals$citeprice)
journals %>%
select_if(is_numeric) %>%
summarise_all(cor_citeprice) %>%
kable()
install.packages("bookdown")
knitr::opts_chunk$set(echo = TRUE)
Journals
str(Journals)
library("AER")
library("ggplot2")
library("dplyr")
library("knitr")
data("Journals")
str(Journals)
View(Journals)
Journals
#journals
summary(journals) #用來看資料特徵
knitr::opts_chunk$set(echo = TRUE)
# 引用單價citeprice，如何影響訂閱subs，進到一個類似x影響y，需求的概念
# -0.42是correlation
#
library(psych)
# journals %>%
#   select(citeprice,subs) %>%
#   pairs.panels()
# 更理想的寫法，畢竟select這個函數一定有人用過，而且隸屬於兩個以上的套件
journals %>%
dplyr::select(citeprice,subs) %>% #select: extract column by name
pairs.panels()
journals %>%
dplyr::select(citeprice,subs) %>%
dplyr::mutate_all(log) %>% #取log使他較接近常態分配，OLS迴歸斜率也較清楚。
pairs.panels()
# 判斷變數是否為數值類別，先建立函數功能。
is_numeric<-function(x) all(is.numeric(x))
# 計算數數與citeprice的相關係數，先建立函數功能，那要另外建立，是因為有一個citeprice這個變數，我想要先訂下來。
cor_citeprice<-function(x) cor(x,journals$citeprice)
journals %>%
select_if(is_numeric) %>%
summarise_all(cor_citeprice) %>% #summarise是接近敘述統計量的意思
kable() #kable讓印的表變得比較好看
#回去寫：佐證foundingyear和subs的立足點不同的佐證。correlation
knitr::opts_chunk$set(echo = TRUE)
cor(x,journals$citeprice)
cor_subs <- function(x){
cor(x,journals$citeprice)
}
knitr::opts_chunk$set(echo = TRUE)
journals %>%
select_if(is_numeric) %>%
summarise_all(cor_subs)
knitr::opts_chunk$set(echo = TRUE)
cor_subs <- function(x){
cor(x,journals$subs)
}
journals %>%
select_if(is_numeric) %>%
summarise_all(cor_subs) #cor(foundingyear, subs)
knitr::opts_chunk$set(echo = TRUE)
# 判斷變數是否為數值類別，先建立函數功能。
is_numeric<-function(x) all(is.numeric(x))
# 計算數數與citeprice的相關係數，先建立函數功能，那要另外建立，是因為有一個citeprice這個變數，我想要先訂下來。
cor_citeprice<-function(x) cor(x,journals$citeprice)
journals %>%
select_if(is_numeric) %>%
summarise_all(cor_citeprice) %>% #summarise是接近敘述統計量的意思
kable() #kable讓印的表變得比較好看
#回去寫：佐證foundingyear和subs的立足點不同的佐證。correlation
knitr::opts_chunk$set(echo = TRUE)
# 判斷變數是否為數值類別，先建立函數功能。
is_numeric<-function(x) all(is.numeric(x))
# 計算數數與citeprice的相關係數，先建立函數功能，那要另外建立，是因為有一個citeprice這個變數，我想要先訂下來。
cor_citeprice<-function(x) cor(x,journals$citeprice)
journals %>%
select_if(is_numeric) %>%
summarise_all(cor_citeprice) %>% #summarise是接近敘述統計量的意思
kable() #kable讓印的表變得比較好看
#回去寫：佐證foundingyear和subs的立足點不同的佐證。correlation
rm(list=ls())
library(dplyr)
library(psych)
library(haven)
wage1 <- read_dta("http://fmwww.bc.edu/ec-p/data/wooldridge/wage1.dta")
wage1
wage1
wage1 %>% select(educ, wage)
wage1 %>% select(educ, wage) %>% psych::pairs.panels()
knitr::opts_chunk$set(echo = TRUE)
journals %>%
dplyr::select(citeprice,subs)
knitr::opts_chunk$set(echo = TRUE)
data("Journals")
str(Journals)
View(Journals)
Journals
Journals %>% mutate(citeprice=price/citations) -> journals
#journals
summary(journals) #用來看資料特徵
#price，圖書館訂閱某期刊的價格
#citations，某期刊被引用的次數
#citeprice，期刊引用單價
# 引用單價citeprice，如何影響訂閱subs，進到一個類似x影響y，需求的概念
# -0.42是correlation
#
library(psych)
# journals %>%
#   select(citeprice,subs) %>%
#   pairs.panels()
# 更理想的寫法，畢竟select這個函數一定有人用過，而且隸屬於兩個以上的套件
journals %>%
dplyr::select(citeprice,subs) %>% #select: extract column by name
pairs.panels()
knitr::opts_chunk$set(echo = TRUE)
# 引用單價citeprice，如何影響訂閱subs，進到一個類似x影響y，需求的概念
# -0.42是correlation
#
library(psych)
# journals %>%
#   select(citeprice,subs) %>%
#   pairs.panels()
# 更理想的寫法，畢竟select這個函數一定有人用過，而且隸屬於兩個以上的套件
journals %>%
dplyr::select(citeprice,subs) %>% #select: extract column by name
pairs.panels()
journals %>%
dplyr::select(citeprice,subs) %>%
dplyr::mutate_all(log) %>% #取log使他較接近常態分配，OLS迴歸斜率也較清楚。
pairs.panels()
journals %>%
dplyr::select(citeprice,subs)
journals %>%
dplyr::select(citeprice,subs) %>%
dplyr::mutate_all(log)
wage1 %>% select(educ, wage) %>%
mutate_at(wage, log()) %>%
psych::pairs.panels()
wage1 %>% select(educ, wage) %>%
mutate_at(vars(wage), log()) %>%
psych::pairs.panels()
wage1 %>% select(educ, lwage) %>% psych::pairs.panels()
wage1 %>% select(educ, wage) %>% psych::pairs.panels()
#由目前的圖來看，對wage取log叫好，因為可以使其更接近常態分配。
wage1 %>% mutate(leduc=log(educ)) -> wage2
wage2 %>% select(leduc, wage) %>% psych::pairs.panels()
wage2
View(wage2)
wage1 %>% select(educ, lwage) %>% psych::pairs.panels()
wage1$lwage
wage1 %>% select(educ, lwage) %>% psych::pairs.panels()
wage1 %>% select(educ, lwage) %>% psych::pairs.panels()
wage1 %>%
lm(formula = log(wage)~educ)
wage1 %>%
lm(formula = lwage~educ)
wage1 %>% group_by(educ) %>% summarise(avgwage = mean(wage))
wage1 %>% filter(educ==12)
wage1 %>% filter(educ==12) %>% summarise(avgwage = mean(wage))
wage1 %>% filter(educ==12) %>% summarise(avgwage = mean(wage)) -> avgwage12
avgwage12
wage1 %>% filter(12 <= educ <= 16) %>% summarise(avgwage = mean(wage))
wage1 %>% filter(12<=educ<=16) %>% summarise(avgwage = mean(wage))
?base::Logic
wage1 %>% filter(educ >= 12) %>% summarise(avgwage = mean(wage))
wage1 %>% filter(educ >= 12 & educ <= 16) %>% summarise(avgwage = mean(wage))
wage1 %>% filter(educ >= 12 ) %>% summarise(avgwage = mean(wage))
wage1 %>% filter(educ >= 12 & educ <= 16) %>%
group_by(educ) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(educ) %>%
cut(c(12, 13:15,16)) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16)
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
cut(c(12, 13:15,16)) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(educ = cut(c(12, 13:15, 16))) %>%
summarise(avgwage = mean(wage))
wage1
wage1
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(as.numeric(educ), c(12, 13:15, 16))) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(as.numeric(educ), c(12, 13:15, 16))) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(12, 13:15, 16))) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(12, 13, 15, 16))) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ == 12) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(13, 16))) %>%
summarise(avgwage = mean(wage))
# wage1 %>%
#   filter(educ == 12) %>%
#     summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(16, 16))) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(14))) %>%
summarise(avgwage = mean(wage))
# wage1 %>%
#   filter(educ == 12) %>%
#     summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16)
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(12.9, 15.1))) %>%
summarise(avgwage = mean(wage))
# wage1 %>%
#   filter(educ == 12) %>%
#     summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(12.9, 15.1, 15.9))) %>%
summarise(avgwage = mean(wage))
# wage1 %>%
#   filter(educ == 12) %>%
#     summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(12, 13, 15, 16))) %>%
summarise(avgwage = mean(wage))
# wage1 %>%
#   filter(educ == 12) %>%
#     summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(11, 12, 15, 16))) %>%
summarise(avgwage = mean(wage))
# wage1 %>%
#   filter(educ == 12) %>%
#     summarise(avgwage = mean(wage))
wage1 %>%
filter(educ == 12) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(11, 12, 15, 16))) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ == 16) %>%
summarise(avgwage = mean(wage))
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(11, 12, 15, 16))) %>%
summarise(avgwage = mean(wage)) -> wageforUniTreatment
wageforUniTreatment
wageforUniTreatment %>% rename(cut(educ, c(11, 12, 15, 16)), EducaInterval)
wageforUniTreatment %>% rename(cut(educ, c(11, 12, 15, 16))=EducaInterval)
wageforUniTreatment %>% rename("cut(educ, c(11, 12, 15, 16))"="EducaInterval")
wageforUniTreatment %>% rename(wageforUniTreatment$`cut(educ, c(11, 12, 15, 16))`=EducaInterval)
wageforUniTreatment %>% rename(wageforUniTreatment$`cut(educ, c(11, 12, 15, 16))` = EducaInterval)
wageforUniTreatment %>% rename(wageforUniTreatment$`cut(educ, c(11, 12, 15, 16))` = `EducaInterval`)
wageforUniTreatment %>% rename(wageforUniTreatment$`cut(educ, c(11, 12, 15, 16))` = `Interval`)
wageforUniTreatment %>% rename(wageforUniTreatment$`cut(educ, c(11, 12, 15, 16))` = "Interval")
wageforUniTreatment %>% rename(wageforUniTreatment$`cut(educ, c(11, 12, 15, 16))`="Interval")
names(wageforUniTreatment)[1] <- "EducInterval"
wageforUniTreatment
rownames(wageforUniTreatment)[1:3] <- c(12, 13-15, 16)
rownames(wageforUniTreatment)[1:3] <- c("12", "13-15", "16")
wageforUniTreatment
names(wageforUniTreatment)[1] <- "EducInterval"
rownames(wageforUniTreatment) <- c("12", "13-15", "16")
wageforUniTreatment
wageforUniTreatment
rownames(wageforUniTreatment) <- c("12", "13-15", "16")
rownames(wageforUniTreatment)[1] <- 12
wageforUniTreatment
rownames(wageforUniTreatment)[1] <- "12"
wageforUniTreatment
wageforUniTreatment[1:3, 1] <- c("12","13-15","16")
wageforUniTreatment
wageforUniTreatment[1:3, 1] <- c(12,13-15,16)
wageforUniTreatment
wage1 %>%
filter(educ >= 12 & educ <= 16) %>%
group_by(cut(educ, c(11, 12, 15, 16))) %>%
summarise(avgwage = mean(wage)) -> wageforUniTreatment
# 不曉得有沒有更好的cut的表達方式？
# wage1 %>%
#   filter(educ == 16) %>%
#     summarise(avgwage = mean(wage))
names(wageforUniTreatment)[1] <- "EducInterval"
wageforUniTreatment
wageforUniTreatment
